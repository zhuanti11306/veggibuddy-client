import"./modulepreload-polyfill-Dqv5PPZA.js";import{B as t,P as e,S as s,D as i,c as r,a as n,V as o,b as a,v as h,g as c,d as l,e as u,f as p,h as d,i as g,j as y,k as m,r as v}from"./index-mTG4zFrc.js";import{L as f,g as x}from"./layout-DvDq0tE0.js";import{g as w,S as D}from"./sampler-BElSqnS2.js";class P extends EventTarget{static longPressThreshold=500;static panThreshold=.0625*Math.min(window.screen.availWidth,window.screen.availHeight);static swipeThreshold=300;currentTarget;pointers=new Map;alivePointerCount=0;gesture=null;constructor(t){super(),this.currentTarget=t,this.currentTarget.addEventListener("pointerdown",this.onPointerDown.bind(this)),this.currentTarget.addEventListener("pointermove",this.onPointerMove.bind(this)),this.currentTarget.addEventListener("pointerup",this.onPointerUp.bind(this)),this.currentTarget.addEventListener("pointercancel",this.onPointerCancel.bind(this)),this.currentTarget.addEventListener("wheel",this.onMouseWheel.bind(this),{passive:!1})}addPointer(t){const e=this.createPointerState(t);return this.pointers.set(t.pointerId,e),this.alivePointerCount++,e}removePointer(t){const e=this.pointers.get(t.pointerId);return e&&(this.pointers.delete(t.pointerId),this.alivePointerCount--),e}createPointerState(t){const e=Date.now();return{id:t.pointerId,x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,startTime:e,time:e}}onPointerDown(t){t.preventDefault();const e=this.addPointer(t);if(1===this.alivePointerCount)this.setSignelTouchGestureState(e);else if(2===this.alivePointerCount){const t=Array.from(this.pointers.values());this.setTwoTouchGestureState(t)}else this.clearGestureState()}onPointerMove(t){t.preventDefault();const e=this.pointers.get(t.pointerId);e&&(e.x=t.clientX,e.y=t.clientY,e.time=Date.now()),"single"===this.gesture?.type?this.analyzeSinglePointerGestureWhenPointerMove(this.gesture):"two"===this.gesture?.type&&this.analyzeTwoPointerGestureWhenPointerMove(this.gesture)}onPointerUp(t){t.preventDefault();const e=this.gesture,s=this.removePointer(t);s&&(s.x=t.clientX,s.y=t.clientY,s.time=Date.now(),s.endTime=Date.now()),"single"===e?.type?(this.analyzeSinglePointerGestureWhenPointerMove(e),this.analyzeSinglePointerGestureWhenPointerUp(e)):"two"===e?.type&&(this.analyzeTwoPointerGestureWhenPointerMove(e),this.analyzeTwoPointerGestureWhenPointerUp(e)),this.clearGestureState()}onPointerCancel(t){t.preventDefault();const e=this.removePointer(t);e&&(e.x=t.clientX,e.y=t.clientY,e.time=Date.now(),e.endTime=Date.now()),this.clearGestureState()}onMouseWheel(t){if(t.preventDefault(),"wheel"!==this.gesture?.type)this.setWheelGestureState(t);else{const e=this.gesture;e.delta={x:t.deltaX,y:t.deltaY,z:t.deltaZ},e.total={x:e.delta.x+e.total.x,y:e.delta.y+e.total.y,z:e.delta.z+e.total.z},this.analyzeWheelGestureWhenWheelRoll(e)}}setSignelTouchGestureState(t){this.gesture&&this.clearGestureState();const e=Date.now();this.gesture={type:"single",pointer:t,startTime:e,startPosition:{x:t.x,y:t.y},lastPosition:{x:t.x,y:t.y},hasMoved:!1,timeoutForLongPress:setTimeout((()=>{this.dispatchLongPressGesture(this.gesture)}),P.longPressThreshold)}}setTwoTouchGestureState(t){this.gesture&&this.clearGestureState();const[e,s]=t,i=Date.now(),r=P.calculateDistance(e,s),n=P.calculateAngle(e,s);this.gesture={type:"two",pointers:[e,s],startTime:i,startDistance:r,lastDistance:r,startAngle:n,lastAngle:n}}setWheelGestureState(t){this.gesture&&this.clearGestureState();const e=Date.now(),s={x:t.deltaX,y:t.deltaY,z:t.deltaZ},i={x:t.deltaX,y:t.deltaY,z:t.deltaZ};this.gesture={type:"wheel",startTime:e,lastDispatchTime:e,delta:s,total:i}}clearGestureState(){this.gesture&&("single"===this.gesture.type?this.clearSingleTouchGestureState(this.gesture):"two"===this.gesture.type&&this.clearTwoTouchGestureState(this.gesture),this.gesture=null)}clearSingleTouchGestureState(t){t.timeoutForLongPress&&(clearTimeout(t.timeoutForLongPress),delete t.timeoutForLongPress)}clearTwoTouchGestureState(t){}analyzeSinglePointerGestureWhenPointerMove(t){const e=t.pointer.x,s=t.pointer.y,i=t.pointer.x-t.startPosition.x,r=t.pointer.y-t.startPosition.y,n=Math.hypot(i,r);(t.hasMoved||P.hasMovedEnough(n))&&(t.hasMoved=!0,t.lastPosition={x:e,y:s},this.dispatchPanGesture(t),t.timeoutForLongPress&&(clearTimeout(t.timeoutForLongPress),delete t.timeoutForLongPress))}analyzeSinglePointerGestureWhenPointerUp(t){if(t.timeoutForLongPress&&(clearTimeout(t.timeoutForLongPress),delete t.timeoutForLongPress),!t.hasMoved&&!t.hasDispatchedAs)return this.dispatchTapGesture(t);const e=Date.now()-t.startTime;return t.hasMoved&&e<P.swipeThreshold?this.dispatchSwipeGesture(t):void 0}analyzeTwoPointerGestureWhenPointerMove(t){const[e,s]=t.pointers,i=P.calculateDistance(e,s),r=i-(t.lastDispatchDistance||t.startDistance),n=P.calculateAngle(e,s),o=n-(t.lastDispatchAngle||t.startAngle);P.hasMovedEnough(r)&&(t.lastDistance=i,this.dispatchZoomGesture(t)),Math.abs(o)>.0625&&(t.lastAngle=n,this.dispatchRotateGesture(t))}analyzeTwoPointerGestureWhenPointerUp(t){}analyzeWheelGestureWhenWheelRoll(t){this.dispatchZoomWithWheel(t)}dispatchTapGesture(t){const e=new G("tap",t);this.currentTarget.dispatchEvent(e)}dispatchLongPressGesture(t){const e=new G("longpress",t);this.currentTarget.dispatchEvent(e)}dispatchZoomGesture(t){const e=new b("zoom",t);this.currentTarget.dispatchEvent(e)}dispatchZoomWithWheel(t){const e=new A("zoom",t);this.currentTarget.dispatchEvent(e)}dispatchRotateGesture(t){const e=new S("rotate",t);this.currentTarget.dispatchEvent(e)}dispatchPanGesture(t){const e=new T("pan",t);this.currentTarget.dispatchEvent(e)}dispatchSwipeGesture(t){const e=new T("swipe",t);this.currentTarget.dispatchEvent(e)}static hasMovedEnough(t){return Math.abs(t)>P.panThreshold}static calculateDistance(t,e){return Math.hypot(e.x-t.x,e.y-t.y)}static calculateAngle(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}}class G extends Event{gesture;position;constructor(t,e){super(t,{bubbles:!0,cancelable:!0}),this.gesture=e,this.position={x:e.pointer.x,y:e.pointer.y},e.lastDispatchPosition={x:e.pointer.x,y:e.pointer.y},e.hasDispatchedAs=t,e.lastDispatchTime=Date.now()}}class T extends Event{gesture;startPosition;currentPosition;move;deltaMove;constructor(t,e){super(t,{bubbles:!0,cancelable:!0}),this.gesture=e,this.startPosition={x:e.startPosition.x,y:e.startPosition.y},this.currentPosition={x:e.pointer.x,y:e.pointer.y},this.move={x:e.pointer.x-e.startPosition.x,y:e.pointer.y-e.startPosition.y},this.deltaMove={x:e.pointer.x-(e.lastDispatchPosition?.x??e.startPosition.x),y:e.pointer.y-(e.lastDispatchPosition?.y??e.startPosition.y)},e.lastDispatchPosition={x:e.pointer.x,y:e.pointer.y},e.hasDispatchedAs=t,e.lastDispatchTime=Date.now()}}class S extends Event{gesture;angle;deltaAngle;constructor(t,e){super(t,{bubbles:!0,cancelable:!0}),this.gesture=e,this.angle=e.lastAngle-e.startAngle,this.deltaAngle=e.lastAngle-(e.lastDispatchAngle??e.startAngle),e.lastDispatchAngle=e.lastAngle,e.lastDispatchTime=Date.now()}}class A extends Event{static zoomScale=1;gesture;distance=NaN;deltaDistance=NaN;scale=NaN;deltaScale=NaN;constructor(t,e){super(t,{bubbles:!0,cancelable:!0}),this.gesture=e,this.distance=e.total.y,this.deltaDistance=e.delta.y,this.scale=this.distance*A.zoomScale,this.deltaScale=this.deltaDistance*A.zoomScale,e.lastDispatchDelta=e.delta,e.lastDispatchTime=Date.now()}}class b extends Event{gesture;distance=NaN;deltaDistance=NaN;scale=NaN;deltaScale=NaN;constructor(t,e){super(t,{bubbles:!0,cancelable:!0}),this.gesture=e,this.distance=e.lastDistance-e.startDistance,this.deltaDistance=e.lastDistance-(e.lastDispatchDistance??e.startDistance),this.scale=this.distance/e.startDistance,this.deltaScale=this.deltaDistance/e.startDistance,e.lastDispatchDistance=e.lastDistance,e.lastDispatchTime=Date.now()}}var z=(t=>(t.component2D="component-2d",t))(z||{});const L=new t("component-2d-layout",{entries:[{key:"geometry",category:"buffer",type:"uniform",visibility:GPUShaderStage.VERTEX},{key:"texture",category:"texture",visibility:GPUShaderStage.FRAGMENT},{key:"sampler",category:"sampler",type:"filtering",visibility:GPUShaderStage.FRAGMENT}]}),E=new s("component-2d-shader","struct Geometry {\r\n    size: vec2f,\r\n    position: vec2f,\r\n};\r\n\r\nstruct VertexOutput {\r\n    @builtin(position) position: vec4f,\r\n    @location(0) uv: vec2f,\r\n};\r\n\r\n@group(0) @binding(0) var<uniform> screen: vec2f;\r\n\r\n@group(1) @binding(0) var<uniform> geometry: Geometry;\r\n@group(1) @binding(1) var component_texture: texture_2d<f32>;\r\n@group(1) @binding(2) var component_sampler: sampler;\r\n\r\n@vertex\r\nfn vertex_main(@location(0) pos: vec2f) -> VertexOutput {\r\n    var output: VertexOutput;\r\n    // pos 的範圍為 0.0 至 1.0\r\n    // 將本地座標縮放到元件的畫素尺寸\r\n    // 然後平移到元件的左上角畫素位置\r\n    // 注意：這裡假設 geometry.position 是左上角座標\r\n    let world_pos = geometry.position + pos * geometry.size;\r\n\r\n    // 將世界畫素座標轉換為標準化設備座標 (NDC, -1.0 to 1.0)\r\n    let ndc_pos = vec2f(\r\n        (world_pos.x / screen.x) * 2.0 - 1.0,\r\n        (world_pos.y / screen.y) * -2.0 + 1.0  // Y 軸向下為正，所以要反轉\r\n    );\r\n\r\n    output.position = vec4f(ndc_pos, 0.0, 1.0);\r\n    output.uv = pos; \r\n    \r\n    return output;\r\n}\r\n\r\n@fragment\r\nfn fragment_main(input: VertexOutput) -> @location(0) vec4f {\r\n    // 使用從 vertex shader 傳來的 uv 座標對紋理進行採樣\r\n    return textureSample(component_texture, component_sampler, input.uv);\r\n}"),M=new e("component-2d-pipeline",{layout:[f.Screen,L],vertex:[i],shader:{vertex:{module:E,entryPoint:"vertex_main"},fragment:{module:E,entryPoint:"fragment_main"}}});class C{static CANVAS_SCALE_FACTOR=1;geometry=null;parent=null;uniformBuffer;uniformBindGroup;canvas;context;texture;isVisible=!0;isGeometryDirty=!0;isAppearanceDirty=!0;constructor(){this.canvas=new OffscreenCanvas(256,256),this.context=this.canvas.getContext("2d"),this.context.imageSmoothingEnabled=!0,this.context.imageSmoothingQuality="high",this.texture=r("component-2d-texture",this.canvas),this.uniformBuffer=new n("component-2d-uniform",{size:o.vec2,position:o.vec2}),this.uniformBindGroup=new a("component-2d-uniform-bind-group",{layout:L,entries:{geometry:this.uniformBuffer,texture:this.texture,sampler:w(D.Nearest)}})}getPreferredSize(){return{width:256,height:256}}getMinSize(){return{width:0,height:0}}getMaxSize(){return{width:1/0,height:1/0}}setParent(t){this.parent=t}setGeometry(t){if(t||this.geometry){if(!t)return this.geometry=null,void(this.isGeometryDirty=!0);if(t=structuredClone(t),!this.geometry)return this.geometry=t,void(this.isGeometryDirty=!0);this.geometry.size.width!==t.size.width||this.geometry.size.height!==t.size.height?(this.geometry=t,this.isGeometryDirty=!0,this.redraw()):this.geometry.position.x===t.position.x&&this.geometry.position.y===t.position.y||(this.geometry.position=t.position,this.isGeometryDirty=!0)}}getGeometry(){return this.geometry}redraw(){this.isAppearanceDirty=!0}update(t){(this.isGeometryDirty||this.isAppearanceDirty)&&(this.isGeometryDirty&&(this.updateGeometry(),this.isGeometryDirty=!1),this.isAppearanceDirty&&(this.drawAppearance(),this.texture.setSource(this.canvas),this.isAppearanceDirty=!1))}updateGeometry(){if(!this.geometry)return;const{size:t,position:e}=this.geometry;this.canvas.width=t.width*C.CANVAS_SCALE_FACTOR,this.canvas.height=t.height*C.CANVAS_SCALE_FACTOR,this.texture.setSize({width:this.canvas.width,height:this.canvas.height}),this.uniformBindGroup.destroy(),this.uniformBuffer.set("position",h(e.x,e.y)),this.uniformBuffer.set("size",h(t.width,t.height))}drawAppearance(){this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.setTransform(C.CANVAS_SCALE_FACTOR,0,0,C.CANVAS_SCALE_FACTOR,0,0)}render(){c()?.label==z.component2D&&this.geometry&&l({pipeline:M,buffer:"quadrilateral",bindGroups:[null,this.uniformBindGroup]})}}const W={performLayout:()=>{}};class N extends C{children=[];constraints=new Map;isLayoutDirty=!0;layoutManager=W;constructor(){super()}setLayout(t){this.layoutManager=t||W,this.isLayoutDirty=!0}getLayout(){return this.layoutManager===W?null:this.layoutManager}addChild(t,e){this.children.includes(t)?this.constraints.set(t,{...e}):(this.children.push(t),e&&this.constraints.set(t,{...e}),t.setParent(this),this.reperformanceLayout())}removeChild(t){const e=this.children.indexOf(t);-1!==e&&(this.children.splice(e,1),t.setParent(null),t.setGeometry(null),this.constraints.delete(t),this.reperformanceLayout())}getChildren(){return this.children}getConstraints(t){return this.constraints.get(t)??null}reperformanceLayout(){this.isLayoutDirty=!0,this.redraw()}setGeometry(t){super.setGeometry(t),this.isGeometryDirty&&this.reperformanceLayout()}updateLayout(){this.layoutManager.performLayout(this)}update(t){this.isLayoutDirty&&this.updateLayout(),super.update(t),this.isLayoutDirty=!1;for(const e of this.children)e.update(t)}render(){super.render();for(const t of this.children)t.render()}}class _ extends N{static screenResolutionBuffer=new n("screen-resolution",{resolution:o.vec2});static screenBindGroup=x(f.Screen).createBindGroup({resolution:{buffer:_.screenResolutionBuffer}});gestureTarget;geometry;constructor(){super(),this.gestureTarget=new P(u),this.geometry={size:{width:u.width,height:u.height},position:{x:0,y:0}},u.addEventListener("resize",(()=>{const{width:t,height:e}=u;console.log("[DBG] App resized:",t,e),this.setGeometry({size:{width:t,height:e},position:{x:0,y:0}}),_.screenResolutionBuffer.set("resolution",h(u.width,u.height))}))}addEventListener(t,e,s){this.gestureTarget.addEventListener(t,e,s)}dispatchEvent(t){return this.gestureTarget.dispatchEvent(t)}removeEventListener(t,e,s){this.gestureTarget.removeEventListener(t,e,s)}render(){p({label:z.component2D,colorAttachments:["canvas"],defaultBindGroups:[_.screenBindGroup]}),super.render(),d()}update(t){super.update(t)}getGeometry(){return this.geometry}drawAppearance(){super.drawAppearance(),console.log("[DBG] Drawing App appearance...");const{width:t,height:e}=this.getGeometry().size;this.context.fillStyle="magenta",this.context.fillRect(0,0,t,e),this.context.fillStyle="cyan",this.context.fillRect(0,0,t/2,e/2),this.context.fillStyle="yellow",this.context.fillRect(t/2,e/2,t/2,e/2),this.context.fillStyle="white",this.context.beginPath(),this.context.arc(t/2,e/2,50,0,2*Math.PI),this.context.fill()}}const R=g("App not initialized"),{proxy:B}=R;const F=document.createElement("canvas");document.body.appendChild(F),F.width=F.clientWidth,F.height=F.clientHeight,await m(F),function(){if(null!==R.value)throw new Error("App already initialized");if(!y())throw new Error("Render context not initialized");const t=new _;R.set(t)}(),v((t=>{B.update(t),B.render()}));
